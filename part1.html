<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Part 1</title>
    <link rel="stylesheet" href="style.css" />
    <script src="config.js"></script>
  </head>
  <body>
    <main>
      <h1>Part 1 (Attractiveness)</h1>
      <p class="muted">
        You will answer 20 questions. Each question shows 4 slogans for a brand and a persona. For each question, select:
        <br />
        <strong>Hits you first</strong> - the slogan that grabs you at first glance (single choice).
        <br />
        <strong>Persona-fit best</strong> - the slogan that fits the given persona best (single choice).
        <br />
        <strong>Familiarity</strong> - required yes/no questions for the brand and the quote.
        <br />
        You may pick the same option for both single-choice questions. The familiarity answers do not affect scoring.
        The quote text is a separate reference and may not appear in the four options.
        <br />
        About one hour later, we will publish a brief follow-up. Please watch for it.
      </p>

      <div id="pidCard" class="card">
        <div class="row">
          <label>
            PROLIFIC_PID:
            <input id="pidInput" type="text" placeholder="e.g., 5f2c..." autocomplete="off" />
          </label>
          <button id="startBtn" type="button">Start</button>
        </div>
        <p id="pidError" class="error" style="display: none"></p>
        <p class="muted">
          If you came from Prolific, this will be auto-filled from the URL parameter <span class="code">PROLIFIC_PID</span>.
        </p>
      </div>

      <div id="surveyCard" class="card" style="display: none">
        <div class="row">
          <div>
            <div><strong>Participant:</strong> <span id="pidLabel"></span></div>
            <div class="muted">
              <span><strong>Block:</strong> <span id="blockLabel"></span></span>
              <span style="margin-left: 10px"><strong>Part:</strong> part1</span>
            </div>
          </div>
          <div style="margin-left: auto" class="muted">
            Progress: <span id="progressLabel">0/20</span>
          </div>
        </div>
      </div>

      <div id="questionsRoot"></div>

      <div id="navCard" class="card" style="display: none">
        <p id="navHint" class="muted" style="display: none"></p>
        <div class="footer-actions">
          <button id="nextBtn" type="button" disabled>Next</button>
        </div>
      </div>

      <div id="submitCard" class="card" style="display: none">
        <p id="submitError" class="error" style="display: none"></p>
        <div class="footer-actions">
          <button id="submitBtn" type="button">Submit</button>
          <span class="muted">Submits to: <span id="submitUrlLabel" class="code"></span></span>
        </div>
      </div>

      <div id="doneCard" class="card" style="display: none">
        <h2 style="margin: 0 0 10px">Done</h2>
        <p>Completion code:</p>
        <div class="code" id="completionCode"></div>
      </div>
    </main>

    <script type="module">
      import { fnv1a32, getParam, loadJson, pad2, postJson } from "./shared.js";

      const cfg = window.SURVEY_CONFIG || {};
      const submitMode = cfg.submitMode || "cors";

      const pidInput = document.getElementById("pidInput");
      const pidError = document.getElementById("pidError");
      const startBtn = document.getElementById("startBtn");

      const surveyCard = document.getElementById("surveyCard");
      const pidLabel = document.getElementById("pidLabel");
      const blockLabel = document.getElementById("blockLabel");
      const progressLabel = document.getElementById("progressLabel");

      const questionsRoot = document.getElementById("questionsRoot");
      const navCard = document.getElementById("navCard");
      const navHint = document.getElementById("navHint");
      const nextBtn = document.getElementById("nextBtn");
      const submitCard = document.getElementById("submitCard");
      const submitBtn = document.getElementById("submitBtn");
      const submitError = document.getElementById("submitError");
      const submitUrlLabel = document.getElementById("submitUrlLabel");

      const doneCard = document.getElementById("doneCard");
      const completionCode = document.getElementById("completionCode");

      let pid = "";
      let blockId = null;
      let blockData = null;
      let bankInfo = null;
      let quoteMap = null;
      let sequence = [];
      let currentIndex = 0;
      let answersByQid = {};
      let attentionCheck = { overall: "", persona: "", brand_familiarity: "", quote_familiarity: "", pass: false };
      let questionCount = 0;

      function showError(el, msg) {
        el.textContent = msg;
        el.style.display = msg ? "block" : "none";
      }

      function getCheckedValue(name) {
        const el = document.querySelector(`input[name="${name}"]:checked`);
        return el ? el.value : "";
      }

      async function loadQuoteMap() {
        if (quoteMap !== null) return quoteMap;
        try {
          const data = await loadJson("qwq_quote_by_question.json");
          quoteMap = data && data.questions ? data.questions : {};
        } catch (_) {
          quoteMap = {};
        }
        return quoteMap;
      }

      function setProgressLabel(item) {
        if (!blockData || !item) {
          progressLabel.textContent = "0/0";
          return;
        }
        if (item.type === "attention") {
          progressLabel.textContent = "Quality check";
          return;
        }
        progressLabel.textContent = `Question ${item.index}/${questionCount}`;
      }

      function readQuestionValues(q) {
        const qid = q.question_id;
        const overall = getCheckedValue(`q${qid}_overall`);
        const persona = getCheckedValue(`q${qid}_persona`);
        const brandFam = getCheckedValue(`q${qid}_brand_fam`);
        const quoteFam = getCheckedValue(`q${qid}_quote_fam`);
        return { overall, persona, brandFam, quoteFam };
      }

      function readAttentionValues() {
        const overall = getCheckedValue("attention_overall");
        const persona = getCheckedValue("attention_persona");
        const brandFam = getCheckedValue("attention_brand_fam");
        const quoteFam = getCheckedValue("attention_quote_fam");
        return { overall, persona, brandFam, quoteFam };
      }

      function isQuestionComplete(values) {
        return values.overall && values.persona && values.brandFam && values.quoteFam;
      }

      function isAttentionPass(values) {
        return values.overall === "B" && values.persona === "B";
      }

      function isAttentionComplete(values) {
        return values.overall && values.persona && values.brandFam && values.quoteFam;
      }

      function updateNavState() {
        const item = sequence[currentIndex];
        if (!item) return;
        let complete = false;
        let hint = "";
        if (item.type === "attention") {
          const values = readAttentionValues();
          complete = isAttentionComplete(values);
          if (!complete) hint = "Complete all required fields to continue.";
        } else {
          const values = readQuestionValues(item.q);
          complete = isQuestionComplete(values);
          if (!complete) hint = "Complete all required fields to continue.";
        }

        const isLast = currentIndex === sequence.length - 1;
        navCard.style.display = isLast ? "none" : "block";
        submitCard.style.display = isLast ? "block" : "none";
        nextBtn.disabled = !complete;
        submitBtn.disabled = !complete;
        navHint.textContent = hint;
        navHint.style.display = hint ? "block" : "none";
      }

      function renderAttentionCheck() {
        const card = document.createElement("div");
        card.className = "card";
        card.id = "attention-check";

        const title = document.createElement("div");
        title.innerHTML = `<strong>Quality check</strong> <span class="muted">(Brand: ExampleBrand · Persona: ExamplePersona)</span>`;
        card.appendChild(title);

        const text = document.createElement("div");
        text.className = "muted";
        text.style.marginTop = "6px";
        text.textContent = "Please select option B for both choices below. This is not part of the 20 questions.";
        card.appendChild(text);

        const fam = document.createElement("div");
        fam.className = "muted";
        fam.style.marginTop = "10px";

        const brandPrompt = document.createElement("div");
        brandPrompt.innerHTML = `<strong>Brand familiarity</strong> (required): Are you familiar with this brand?`;
        fam.appendChild(brandPrompt);
        const brandChoices = document.createElement("div");
        brandChoices.className = "row";
        brandChoices.style.marginTop = "6px";
        brandChoices.innerHTML = `
          <label><input type="radio" name="attention_brand_fam" value="yes" /> Yes</label>
          <label><input type="radio" name="attention_brand_fam" value="no" /> No</label>
        `;
        fam.appendChild(brandChoices);

        const quotePrompt = document.createElement("div");
        quotePrompt.style.marginTop = "10px";
        quotePrompt.innerHTML = `<strong>Quote familiarity</strong> (required): Are you familiar with this quote?`;
        fam.appendChild(quotePrompt);
        const quoteLine = document.createElement("div");
        quoteLine.className = "code";
        quoteLine.style.marginTop = "6px";
        quoteLine.textContent = "Something's coming, and I don't know what it is...";
        fam.appendChild(quoteLine);
        const quoteChoices = document.createElement("div");
        quoteChoices.className = "row";
        quoteChoices.style.marginTop = "6px";
        quoteChoices.innerHTML = `
          <label><input type="radio" name="attention_quote_fam" value="yes" /> Yes</label>
          <label><input type="radio" name="attention_quote_fam" value="no" /> No</label>
        `;
        fam.appendChild(quoteChoices);

        card.appendChild(fam);

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th style="width: 60%">Option</th>
              <th style="width: 20%">Hits you first</th>
              <th style="width: 20%">Persona-fit best</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");
        for (const label of ["A", "B", "C", "D"]) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="option-label">${label}.</span>Option ${label}</td>
            <td><input type="radio" name="attention_overall" value="${label}" /></td>
            <td><input type="radio" name="attention_persona" value="${label}" /></td>
          `;
          tbody.appendChild(tr);
        }
        card.appendChild(table);

        card.addEventListener("change", updateNavState);
        return card;
      }

      function renderQuestion(q, quoteText) {
        const card = document.createElement("div");
        card.className = "card";
        card.id = `q-${q.question_id}`;

        const title = document.createElement("div");
        const displayId = q.display_id || q.question_id;
        title.innerHTML = `<strong>Question ${displayId}</strong> <span class="muted">(Brand: ${q.brand} · Persona: ${q.persona})</span>`;
        card.appendChild(title);

        const fam = document.createElement("div");
        fam.className = "muted";
        fam.style.marginTop = "10px";

        const brandPrompt = document.createElement("div");
        brandPrompt.innerHTML = `<strong>Brand familiarity</strong> (required): Are you familiar with this brand?`;
        fam.appendChild(brandPrompt);
        const brandChoices = document.createElement("div");
        brandChoices.className = "row";
        brandChoices.style.marginTop = "6px";
        brandChoices.innerHTML = `
          <label><input type="radio" name="q${q.question_id}_brand_fam" value="yes" /> Yes</label>
          <label><input type="radio" name="q${q.question_id}_brand_fam" value="no" /> No</label>
        `;
        fam.appendChild(brandChoices);

        const quotePrompt = document.createElement("div");
        quotePrompt.style.marginTop = "10px";
        quotePrompt.innerHTML = `<strong>Quote familiarity</strong> (required): Are you familiar with this quote?`;
        fam.appendChild(quotePrompt);
        const quoteLine = document.createElement("div");
        quoteLine.className = "code";
        quoteLine.style.marginTop = "6px";
        quoteLine.textContent = quoteText || "";
        fam.appendChild(quoteLine);
        const quoteChoices = document.createElement("div");
        quoteChoices.className = "row";
        quoteChoices.style.marginTop = "6px";
        quoteChoices.innerHTML = `
          <label><input type="radio" name="q${q.question_id}_quote_fam" value="yes" /> Yes</label>
          <label><input type="radio" name="q${q.question_id}_quote_fam" value="no" /> No</label>
        `;
        fam.appendChild(quoteChoices);

        card.appendChild(fam);

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th style="width: 60%">Option</th>
              <th style="width: 20%">Hits you first</th>
              <th style="width: 20%">Persona-fit best</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");

        for (const opt of q.options) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="option-label">${opt.label}.</span>${opt.text}</td>
            <td><input type="radio" name="q${q.question_id}_overall" value="${opt.label}" /></td>
            <td><input type="radio" name="q${q.question_id}_persona" value="${opt.label}" /></td>
          `;
          tbody.appendChild(tr);
        }

        card.appendChild(table);

        card.addEventListener("change", updateNavState);
        return card;
      }

      function buildSequence() {
        sequence = [];
        const insertAfterIndex = Math.max(0, Math.floor(blockData.questions.length / 2) - 1);
        let inserted = false;
        blockData.questions.forEach((q, idx) => {
          sequence.push({ type: "question", q, index: idx + 1 });
          if (!inserted && idx === insertAfterIndex) {
            sequence.push({ type: "attention" });
            inserted = true;
          }
        });
        if (!inserted) {
          sequence.push({ type: "attention" });
        }
      }

      function renderCurrent() {
        const item = sequence[currentIndex];
        questionsRoot.innerHTML = "";
        if (!item) return;
        if (item.type === "attention") {
          questionsRoot.appendChild(renderAttentionCheck());
        } else {
          const quoteInfo = quoteMap ? quoteMap[String(item.q.question_id)] : null;
          const quoteText = quoteInfo ? quoteInfo.quote : "";
          questionsRoot.appendChild(renderQuestion(item.q, quoteText));
        }
        setProgressLabel(item);
        updateNavState();
      }

      function storeCurrentItem() {
        const item = sequence[currentIndex];
        if (!item) return false;
        if (item.type === "attention") {
          const values = readAttentionValues();
          const pass = isAttentionPass(values);
          if (!isAttentionComplete(values)) return false;
          attentionCheck = {
            overall: values.overall,
            persona: values.persona,
            brand_familiarity: values.brandFam,
            quote_familiarity: values.quoteFam,
            pass,
          };
          return true;
        }
        const values = readQuestionValues(item.q);
        if (!isQuestionComplete(values)) return false;
        answersByQid[item.q.question_id] = {
          question_id: item.q.question_id,
          overall_best: values.overall,
          persona_fit_best: values.persona,
          brand_unfamiliar: values.brandFam === "no",
          quote_unfamiliar: values.quoteFam === "no",
        };
        return true;
      }

      async function start() {
        showError(pidError, "");
        pid = (pidInput.value || "").trim();
        if (!pid) {
          showError(pidError, "Please enter PROLIFIC_PID.");
          return;
        }

        const overrideBlock = getParam("BLOCK_ID");
        if (overrideBlock) {
          const parsed = Number(overrideBlock);
          blockId = Number.isFinite(parsed) ? parsed : 20 + (fnv1a32(pid) % 10);
        } else {
          blockId = 20 + (fnv1a32(pid) % 10);
        }
        pidLabel.textContent = pid;
        blockLabel.textContent = String(blockId);
        surveyCard.style.display = "block";
        navCard.style.display = "block";
        submitCard.style.display = "none";
        submitUrlLabel.textContent = cfg.submitUrl || "(not set)";

        const blockUrl = `blocks/block_${pad2(blockId)}.json`;
        blockData = await loadJson(blockUrl);
        try {
          bankInfo = await loadJson("bank_info.json");
        } catch (_) {
          bankInfo = null;
        }
        questionCount = blockData.questions.length;
        answersByQid = {};
        attentionCheck = { overall: "", persona: "", brand_familiarity: "", quote_familiarity: "", pass: false };
        currentIndex = 0;
        buildSequence();
        quoteMap = await loadQuoteMap();
        renderCurrent();
      }

      async function submit() {
        showError(submitError, "");
        submitBtn.disabled = true;

        try {
          if (!cfg.submitUrl) {
            throw new Error("submitUrl not set in config.js");
          }

          if (!storeCurrentItem()) {
            showError(submitError, "Please complete all required fields on this question.");
            submitBtn.disabled = false;
            return;
          }

          const answers = [];
          const missing = [];
          for (const q of blockData.questions) {
            const qid = q.question_id;
            const ans = answersByQid[qid];
            if (!ans) {
              missing.push(qid);
              continue;
            }
            answers.push(ans);
          }

          if (missing.length) {
            showError(submitError, `Please answer all questions (missing: ${missing.slice(0, 5).join(", ")}${missing.length > 5 ? "..." : ""}).`);
            const first = document.getElementById(`q-${missing[0]}`);
            if (first) first.scrollIntoView({ behavior: "smooth", block: "start" });
            submitBtn.disabled = false;
            return;
          }

          const payload = {
            timestamp: new Date().toISOString(),
            bank_id: bankInfo && bankInfo.bank_id ? bankInfo.bank_id : "",
            PROLIFIC_PID: pid,
            STUDY_ID: getParam("STUDY_ID") || "",
            SESSION_ID: getParam("SESSION_ID") || "",
            study_part: "part1",
            block_id: blockId,
            attention_check: {
              overall: attentionCheck.overall,
              persona: attentionCheck.persona,
              brand_familiarity: attentionCheck.brand_familiarity,
              quote_familiarity: attentionCheck.quote_familiarity,
              pass: attentionCheck.pass,
            },
            question_ids: blockData.questions.map((q) => q.question_id),
            answers,
            client: {
              user_agent: navigator.userAgent,
              page: "part1",
            },
          };

          await postJson(cfg.submitUrl, payload, submitMode);

          submitCard.style.display = "none";
          doneCard.style.display = "block";
          completionCode.textContent = cfg.completionCodePart1 || "REPLACE_ME_PART1";
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (e) {
          showError(submitError, String(e && e.message ? e.message : e));
          submitBtn.disabled = false;
        }
      }

      startBtn.addEventListener("click", () => start());
      nextBtn.addEventListener("click", () => {
        showError(submitError, "");
        if (!storeCurrentItem()) return;
        currentIndex = Math.min(sequence.length - 1, currentIndex + 1);
        renderCurrent();
      });
      submitBtn.addEventListener("click", () => submit());

      // auto-fill PID if Prolific provides it
      const pidFromUrl = getParam("PROLIFIC_PID");
      if (pidFromUrl) {
        pidInput.value = pidFromUrl;
        start();
      }
    </script>
  </body>
</html>

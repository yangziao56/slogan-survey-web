<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Part 2</title>
    <link rel="stylesheet" href="style.css" />
    <script src="config.js"></script>
  </head>
  <body>
    <main>
      <h1>Part 2 (Recall)</h1>
      <p class="muted">
        For each question, select:
        <br />
        <strong>Most memorable</strong> - the slogan that sticks in your mind most (not necessarily your favorite; single choice).
        <br />
        <strong>Not seen last time</strong> - check any slogans you did not see in the previous survey (multi-select).
        <br />
        The single choice is required. The multi-select can be none or multiple; if unsure, leave it unchecked.
      </p>

      <div id="pidCard" class="card">
        <div class="row">
          <label>
            PROLIFIC_PID:
            <input id="pidInput" type="text" placeholder="e.g., 5f2c..." autocomplete="off" />
          </label>
          <button id="startBtn" type="button">Start</button>
        </div>
        <p id="pidError" class="error" style="display: none"></p>
      </div>

      <div id="surveyCard" class="card" style="display: none">
        <div class="row">
          <div>
            <div><strong>Participant:</strong> <span id="pidLabel"></span></div>
            <div class="muted">
              <span><strong>Block:</strong> <span id="blockLabel"></span></span>
              <span style="margin-left: 10px"><strong>Part:</strong> part2</span>
            </div>
          </div>
          <div style="margin-left: auto" class="muted">
            Progress: <span id="progressLabel">0/0</span>
          </div>
        </div>
      </div>

      <div id="questionsRoot"></div>

      <div id="navCard" class="card" style="display: none">
        <p id="navHint" class="muted" style="display: none"></p>
        <div class="footer-actions">
          <button id="nextBtn" type="button" disabled>Next</button>
        </div>
      </div>

      <div id="submitCard" class="card" style="display: none">
        <p id="submitError" class="error" style="display: none"></p>
        <div class="footer-actions">
          <button id="submitBtn" type="button">Submit</button>
          <span class="muted">Submits to: <span id="submitUrlLabel" class="code"></span></span>
        </div>
      </div>

      <div id="doneCard" class="card" style="display: none">
        <h2 style="margin: 0 0 10px">Done</h2>
        <p>Completion code:</p>
        <div class="code" id="completionCode"></div>
      </div>
    </main>

    <script type="module">
      import { fnv1a32, getParam, loadJson, pad2, postJson } from "./shared.js";

      const cfg = window.SURVEY_CONFIG || {};
      const submitMode = cfg.submitMode || "cors";

      const pidInput = document.getElementById("pidInput");
      const pidError = document.getElementById("pidError");
      const startBtn = document.getElementById("startBtn");

      const surveyCard = document.getElementById("surveyCard");
      const pidLabel = document.getElementById("pidLabel");
      const blockLabel = document.getElementById("blockLabel");
      const progressLabel = document.getElementById("progressLabel");

      const questionsRoot = document.getElementById("questionsRoot");
      const navCard = document.getElementById("navCard");
      const navHint = document.getElementById("navHint");
      const nextBtn = document.getElementById("nextBtn");
      const submitCard = document.getElementById("submitCard");
      const submitBtn = document.getElementById("submitBtn");
      const submitError = document.getElementById("submitError");
      const submitUrlLabel = document.getElementById("submitUrlLabel");

      const doneCard = document.getElementById("doneCard");
      const completionCode = document.getElementById("completionCode");

      let pid = "";
      let blockId = null;
      let blockData = null;
      let bankInfo = null;
      let sequence = [];
      let currentIndex = 0;
      let answersByQid = {};
      let attentionCheck = { most_memorable: "", not_seen: [], pass: false };
      let questionCount = 0;

      function showError(el, msg) {
        el.textContent = msg;
        el.style.display = msg ? "block" : "none";
      }

      function getCheckedValue(name) {
        const el = document.querySelector(`input[name="${name}"]:checked`);
        return el ? el.value : "";
      }

      function setProgressLabel(item) {
        if (!blockData || !item) {
          progressLabel.textContent = "0/0";
          return;
        }
        if (item.type === "attention") {
          progressLabel.textContent = "Quality check";
          return;
        }
        progressLabel.textContent = `Question ${item.index}/${questionCount}`;
      }

      function readQuestionValues(q) {
        const qid = q.question_id;
        const memorable = getCheckedValue(`q${qid}_memorable`);
        const not_seen = [];
        for (const opt of q.options) {
          const el = document.getElementById(`q${qid}_not_seen_${opt.label}`);
          if (el && el.checked) not_seen.push(opt.label);
        }
        return { memorable, not_seen };
      }

      function readAttentionValues() {
        const memorable = getCheckedValue("attention_memorable");
        const not_seen = [];
        for (const label of ["A", "B", "C", "D"]) {
          const el = document.getElementById(`attention_not_seen_${label}`);
          if (el && el.checked) not_seen.push(label);
        }
        return { memorable, not_seen };
      }

      function isQuestionComplete(values) {
        return !!values.memorable;
      }

      function isAttentionPass(values) {
        return values.memorable === "C" && values.not_seen.length === 1 && values.not_seen[0] === "A";
      }

      function isAttentionComplete(values) {
        return !!values.memorable;
      }

      function updateNavState() {
        const item = sequence[currentIndex];
        if (!item) return;
        let complete = false;
        let hint = "";
        if (item.type === "attention") {
          const values = readAttentionValues();
          complete = isAttentionComplete(values);
          if (!complete) hint = "Complete the quality check to continue.";
        } else {
          const values = readQuestionValues(item.q);
          complete = isQuestionComplete(values);
          if (!complete) hint = "Select the most memorable slogan to continue.";
        }

        const isLast = currentIndex === sequence.length - 1;
        navCard.style.display = isLast ? "none" : "block";
        submitCard.style.display = isLast ? "block" : "none";
        nextBtn.disabled = !complete;
        submitBtn.disabled = !complete;
        navHint.textContent = hint;
        navHint.style.display = hint ? "block" : "none";
      }

      function renderAttentionCheck() {
        const card = document.createElement("div");
        card.className = "card";
        card.id = "attention-check";

        const title = document.createElement("div");
        title.innerHTML = `<strong>Quality check</strong>`;
        card.appendChild(title);

        const text = document.createElement("div");
        text.className = "muted";
        text.style.marginTop = "6px";
        text.textContent = "Please select option C as most memorable and check option A only for not seen. This is not part of the 20 questions.";
        card.appendChild(text);

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th style="width: 60%">Option</th>
              <th style="width: 20%">Most memorable</th>
              <th style="width: 20%">Not seen last time</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");
        for (const label of ["A", "B", "C", "D"]) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="option-label">${label}.</span>Option ${label}</td>
            <td><input type="radio" name="attention_memorable" value="${label}" /></td>
            <td><input type="checkbox" id="attention_not_seen_${label}" /></td>
          `;
          tbody.appendChild(tr);
        }
        card.appendChild(table);

        card.addEventListener("change", updateNavState);
        return card;
      }

      function renderQuestion(q) {
        const card = document.createElement("div");
        card.className = "card";
        card.id = `q-${q.question_id}`;

        const title = document.createElement("div");
        const displayId = q.display_id || q.question_id;
        title.innerHTML = `<strong>Question ${displayId}</strong> <span class="muted">(Brand: ${q.brand} Â· Persona: ${q.persona})</span>`;
        card.appendChild(title);

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th style="width: 60%">Option</th>
              <th style="width: 20%">Most memorable</th>
              <th style="width: 20%">Not seen last time</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");
        for (const opt of q.options) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="option-label">${opt.label}.</span>${opt.text}</td>
            <td><input type="radio" name="q${q.question_id}_memorable" value="${opt.label}" /></td>
            <td><input type="checkbox" id="q${q.question_id}_not_seen_${opt.label}" /></td>
          `;
          tbody.appendChild(tr);
        }
        card.appendChild(table);
        const note = document.createElement("div");
        note.className = "muted";
        note.style.marginTop = "8px";
        note.textContent = "Not seen last time: check all that apply (can be none).";
        card.appendChild(note);
        card.addEventListener("change", updateNavState);
        return card;
      }

      function buildSequence() {
        sequence = [];
        const insertAfterIndex = Math.max(0, Math.floor(blockData.questions.length / 2) - 1);
        let inserted = false;
        blockData.questions.forEach((q, idx) => {
          sequence.push({ type: "question", q, index: idx + 1 });
          if (!inserted && idx === insertAfterIndex) {
            sequence.push({ type: "attention" });
            inserted = true;
          }
        });
        if (!inserted) {
          sequence.push({ type: "attention" });
        }
      }

      function renderCurrent() {
        const item = sequence[currentIndex];
        questionsRoot.innerHTML = "";
        if (!item) return;
        if (item.type === "attention") {
          questionsRoot.appendChild(renderAttentionCheck());
        } else {
          questionsRoot.appendChild(renderQuestion(item.q));
        }
        setProgressLabel(item);
        updateNavState();
      }

      function storeCurrentItem() {
        const item = sequence[currentIndex];
        if (!item) return false;
        if (item.type === "attention") {
          const values = readAttentionValues();
          const pass = isAttentionPass(values);
          if (!isAttentionComplete(values)) return false;
          attentionCheck = {
            most_memorable: values.memorable,
            not_seen: values.not_seen,
            pass,
          };
          return true;
        }
        const values = readQuestionValues(item.q);
        if (!isQuestionComplete(values)) return false;
        answersByQid[item.q.question_id] = {
          question_id: item.q.question_id,
          most_memorable: values.memorable,
          not_seen: values.not_seen,
        };
        return true;
      }

      async function start() {
        showError(pidError, "");
        pid = (pidInput.value || "").trim();
        if (!pid) {
          showError(pidError, "Please enter PROLIFIC_PID.");
          return;
        }

        const overrideBlock = getParam("BLOCK_ID");
        if (overrideBlock) {
          const parsed = Number(overrideBlock);
          blockId = Number.isFinite(parsed) ? parsed : 20 + (fnv1a32(pid) % 10);
        } else {
          blockId = 20 + (fnv1a32(pid) % 10);
        }
        pidLabel.textContent = pid;
        blockLabel.textContent = String(blockId);
        surveyCard.style.display = "block";
        navCard.style.display = "block";
        submitCard.style.display = "none";
        submitUrlLabel.textContent = cfg.submitUrl || "(not set)";

        try {
          bankInfo = await loadJson("bank_info.json");
        } catch (_) {
          bankInfo = null;
        }

        const blockUrl = `part2_blocks/block_${pad2(blockId)}.json`;
        blockData = await loadJson(blockUrl);

        questionCount = blockData.questions.length;
        answersByQid = {};
        attentionCheck = { most_memorable: "", not_seen: [], pass: false };
        currentIndex = 0;
        buildSequence();
        renderCurrent();
      }

      async function submit() {
        showError(submitError, "");
        submitBtn.disabled = true;

        try {
          if (!cfg.submitUrl) {
            throw new Error("submitUrl not set in config.js");
          }

          if (!storeCurrentItem()) {
            showError(submitError, "Please complete all required fields on this question.");
            submitBtn.disabled = false;
            return;
          }

          const answers = [];
          const missing = [];
          for (const q of blockData.questions) {
            const qid = q.question_id;
            const ans = answersByQid[qid];
            if (!ans) {
              missing.push(qid);
              continue;
            }
            answers.push(ans);
          }

          if (missing.length) {
            showError(submitError, `Please answer all questions (missing: ${missing.slice(0, 5).join(", ")}${missing.length > 5 ? "..." : ""}).`);
            const first = document.getElementById(`q-${missing[0]}`);
            if (first) first.scrollIntoView({ behavior: "smooth", block: "start" });
            submitBtn.disabled = false;
            return;
          }

          const payload = {
            timestamp: new Date().toISOString(),
            bank_id: bankInfo && bankInfo.bank_id ? bankInfo.bank_id : "",
            PROLIFIC_PID: pid,
            STUDY_ID: getParam("STUDY_ID") || "",
            SESSION_ID: getParam("SESSION_ID") || "",
            study_part: "part2",
            block_id: blockId,
            attention_check: {
              most_memorable: attentionCheck.most_memorable,
              not_seen: attentionCheck.not_seen,
              pass: attentionCheck.pass,
            },
            question_ids: blockData.questions.map((q) => q.question_id),
            answers,
            client: {
              user_agent: navigator.userAgent,
              page: "part2",
            },
          };

          await postJson(cfg.submitUrl, payload, submitMode);

          submitCard.style.display = "none";
          doneCard.style.display = "block";
          completionCode.textContent = cfg.completionCodePart2 || "REPLACE_ME_PART2";
          window.scrollTo({ top: 0, behavior: "smooth" });
        } catch (e) {
          showError(submitError, String(e && e.message ? e.message : e));
          submitBtn.disabled = false;
        }
      }

      startBtn.addEventListener("click", () => start());
      nextBtn.addEventListener("click", () => {
        showError(submitError, "");
        if (!storeCurrentItem()) return;
        currentIndex = Math.min(sequence.length - 1, currentIndex + 1);
        renderCurrent();
      });
      submitBtn.addEventListener("click", () => submit());

      const pidFromUrl = getParam("PROLIFIC_PID");
      if (pidFromUrl) {
        pidInput.value = pidFromUrl;
        start();
      }
    </script>
  </body>
</html>
